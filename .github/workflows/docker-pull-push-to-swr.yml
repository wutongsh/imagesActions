# 工作流名称
name: Pull Docker Hub Image and Push to Huawei Cloud SWR

# 触发方式：手动触发（workflow_dispatch），并设置可输入的参数（镜像名、标签）
on:
  workflow_dispatch:
    inputs:
      docker_image_name:
        description: 'Docker Hub中的镜像名称（如nginx、mysql、my-private-image）'
        required: true
        type: string
        default: 'nginx' # 默认拉取nginx镜像
      docker_image_tag:
        description: 'Docker Hub中的镜像标签（如latest、1.25.3）'
        required: true
        type: string
        default: 'latest' # 默认标签为latest
      push_image_name:
        description: '要推送的镜像名称（如nginx、mysql、my-private-image）'
        required: true
        type: string
        default: 'nginx' # 默认拉取nginx镜像
      push_image_tag:
        description: '要推送的镜像标签（如latest、1.25.3）'
        required: true
        type: string
        default: 'latest' # 默认标签为latest

# 工作流任务
jobs:
  pull-and-push-image:
    # 运行环境：选择Ubuntu最新版（Docker环境已预装）
    runs-on: ubuntu-latest
    # 环境变量（可通过GitHub Secrets或手动输入参数赋值）
    env:
      # 华为云SWR配置
      SWR_REGISTRY: ${{ secrets.SWR_REGISTRY }}
      SWR_ORG: ${{ secrets.SWR_ORG }}
      # Docker Hub镜像信息（从手动输入参数获取）
      DOCKER_IMAGE: ${{ github.event.inputs.docker_image_name }}
      DOCKER_TAG: ${{ github.event.inputs.docker_image_tag }}
      # 拼接SWR的目标镜像地址
      SWR_TARGET_IMAGE: ${{ secrets.SWR_REGISTRY }}/${{ secrets.SWR_ORG }}/${{ github.event.inputs.push_image_name }}:${{ github.event.inputs.push_image_tag }}

    steps:
      # 步骤1：检出仓库（虽无需代码，但GitHub Actions默认建议执行，可省略）
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：登录Docker Hub（若拉取公有镜像，可注释此步骤；私有镜像必须登录）
      # - name: Login to Docker Hub
      #  uses: docker/login-action@v3
      #  with:
      #    username: ${{ secrets.DOCKER_HUB_USER }}
      #    password: ${{ secrets.DOCKER_HUB_PASS }}

      # 步骤3：登录华为云SWR（使用Docker CLI登录，AK为用户名，SK为密码）
      - name: Login to Huawei Cloud SWR
        run: |
          docker login $SWR_REGISTRY -u ${{ secrets.HUAWEI_CLOUD_AK }} -p ${{ secrets.HUAWEI_CLOUD_SK }}

      # 步骤4：从Docker Hub拉取指定镜像
      - name: Pull image from Docker Hub
        run: |
          docker pull $DOCKER_IMAGE:$DOCKER_TAG

      # 步骤5：为拉取的镜像打SWR的目标标签（Docker镜像推送需匹配仓库地址格式）
      - name: Tag image for Huawei Cloud SWR
        run: |
          docker tag $DOCKER_IMAGE:$DOCKER_TAG $SWR_TARGET_IMAGE

      # 步骤6：推送镜像至华为云SWR
      - name: Push image to Huawei Cloud SWR
        run: |
          docker push $SWR_TARGET_IMAGE

      # 步骤7：可选-清理本地镜像（释放Runner空间）
      - name: Clean up local images
        if: always() # 无论前面步骤是否失败，都执行清理
        run: |
          docker rmi $DOCKER_IMAGE:$DOCKER_TAG $SWR_TARGET_IMAGE || true
          docker logout $SWR_REGISTRY
          docker logout docker.io || true
